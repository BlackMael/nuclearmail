/** @jsx React.DOM */

var Color = require("./Color");
var RCSS = require("rcss");
var _ = require('lodash');
var autoprefixer = require('autoprefixer');

function StyleMixin(stylesByName) {
  var styles = _.mapValues(stylesByName, (style, name) => {
    var convertedStyle = processStyle(style);
    var rcss = RCSS.registerClass(convertedStyle);
    return rcss.className;
  });

  return {styles};
}

function processStyle(style) {
  if (Array.isArray(style)) {
    var processedStyles = style.map(processStyle);
    return Object.assign.apply(null, [{}].concat(processedStyles));
  }

  return _.mapValues(style, (value, key) => {
    if (value instanceof Color) {
      return value.toString();
    }

    // nested, like :hover or :after
    if (_.isObject(value)) {
      return processStyle(value);
    }

    return value;
  });
}

StyleMixin.injectStyles = () => {
  var ap = autoprefixer();
  var tag = document.createElement('style');
  tag.innerHTML = ap.process(RCSS.getStylesString());
  document.getElementsByTagName('head')[0].appendChild(tag);
};

module.exports = StyleMixin;
